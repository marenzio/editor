---
layout: editor
title: MEI Editor for MODE

downloads:
    - name: "Marenzio Madrigal a 6"
      description: "Lib. 4, Di nettare amoroso"
      link: "M-04-6-02.mei"
context-menus:
    - { name: "Breve", icon: "keyboard-00", class: "note", action: "editSet('dur', 'breve')" }
    - { name: "Whole", icon: "keyboard-01", class: "note", action: "editSet('dur', '1')" }
    - { name: "Half", icon: "keyboard-02", class: "note", action: "editSet('dur', '2')" }
    - { name: "Quarter", icon: "keyboard-04", class: "note", action: "editSet('dur', '4')" }
    - { name: "8-th", icon: "keyboard-08", class: "note", action: "editSet('dur', '8')" }
    - { name: "16-th", icon: "keyboard-16", class: "note", action: "editSet('dur', '16')" }
    - { name: "32-th", icon: "keyboard-32", class: "note", action: "editSet('dur', '32')" }
    - { divider: true }
    - { name: "Sharp", class: "note", action: "editSet('accid', 's')" }
    - { name: "Flat", class: "note", action: "editSet('accid', 'f')" }
    - { name: "Remove accid.", class: "note", action: "editSet('accid', '')" }
    - { divider: true }
    - { name: "Slur", class: "note", action: "editInsert('slur')" }
---

<script type="text/javascript">
//<![CDATA[
    
	var vrvToolkit = new verovio.toolkit();
//	var UndoManager = new UndoStack(null);
	var page = 1;
	var zoom = 50;
	var pageHeight = 2970;
	var pageWidth = 2100;
    var show_xml = false;
    var font = 'Leipzig';
    var drag_id = new Array();
    var drag_start;
    var dragging;
    var last_note = ["", 0]
    var editor;
    
    function set_options( ) {
        pageHeight = ($(document).height() - $( "#navbar" ).height() - 4) * 100 / zoom ;
        pageWidth = ($('#svg_panel').width()) * 100 / zoom ; // - $( "#sidbar" ).width();
		border = 50;
		options = JSON.stringify({
					inputFormat: 'mei',
					pageHeight: pageHeight,
					pageWidth: pageWidth,
					border: border,
					scale: zoom,
                    adjustPageHeight: 1,
					ignoreLayout: 1,
                    font: font
				});
		vrvToolkit.setOptions( options );
    }
	
	function load_data(data) {
		set_options();
		vrvToolkit.loadData(data);

		var mei = vrvToolkit.getMEI(0, 1 );
		editor.setValue(mei);
		editor.moveCursorTo(new Number(0), new Number(0));
		UndoManager = require("ace/undomanager").UndoManager;
		editor.getSession().setUndoManager(new UndoManager());

		page = 1;
		load_page();
	}

	function updateACE() {
		var mei = vrvToolkit.getMEI(0, 1 );
		editor.setValue(mei);
		editor.moveCursorTo(new Number(0), new Number(0));		
	}

	function updateVerovio() {
		var data = editor.getValue();
		set_options();
		vrvToolkit.loadData(data);
		load_page();
	}

	function fetchAnnot(fileName, id_cache, type) {
		$.get(fileName, function( annot ) {
			addCriticalNote(id_cache, annot, type);
		}, 'text');
	}

	function addCriticalNote(id_cache, annot, type) {
		switch (type) {
			case "music":
				if (id_cache.length != 1) return;
				var id = id_cache[0];
				editor.find(id);
				editor.find('</measure>',{
					    backwards: false,
					    wrap: true
				});
				editor.find(' ',{
					    backwards: true,
					    wrap: true
				});

				var pos = editor.selection.getCursor();
				var tabSize = editor.getSession().getTabSize();		
				var measureTabs = pos.column/tabSize;

				editor.gotoLine(pos.row + 1);
				for (var i = 0; i < measureTabs+1; i++) editor.indent();		
				editor.insert(annot);

				editor.find('plist=""',{
					    backwards: true,
					    wrap: true
				});
				editor.insert('plist="' + id_cache[0] + '"');
				break;

			case "lyric":
				break;
		}
	}

	function undoAce() {
		editor.getSession().getUndoManager().undo();
	}

	function redoAce() {
		editor.getSession().getUndoManager().redo();
	}

	function load_page() {
		svg = vrvToolkit.renderPage(page, "");
		$("#svg_output").html(svg);
	//	adjust_page_height();
	};
    
    function reload_page( id ) {
		vrvToolkit.redoLayout();
	    var elementPage = vrvToolkit.getPageWithElement( id );
        if (elementPage == 0) {
            console.log( "ID not found" );
            return;
        }
        if (elementPage != page) {
            page = elementPage;
        }
        load_page();
    }
    
	function next_page() {
		if (page >= vrvToolkit.getPageCount()) {
			return;
		}
		page = page + 1;
		load_page();
	};

	function prev_page() {
		if (page <= 1) {
			return;
		}
		page = page - 1;
		load_page();
	};

	function first_page() {
		page = 1;
		load_page();
	};
	
	function last_page() {
		page = vrvToolkit.getPageCount();
		load_page();
	};

	function apply_zoom() {
		set_options();
		vrvToolkit.redoLayout();
		page = 1;
		load_page();
	}

	function zoom_out() {
		if (zoom < 20) {
			return;
		}
		zoom = zoom / 2;
		apply_zoom();
	}

	function zoom_in() {
		if (zoom > 80) {
			return;
		}
		zoom = zoom * 2;
		apply_zoom();
	}
	
	function adjust_page_height() {
		// adjust the height of the panel
		if ( $('#svg_panel svg') ) {
            zoomed_height = pageHeight * zoom / 100;
            if ( zoomed_height < $('#svg_panel svg').height() ) {
                zoomed_height = $('#svg_panel svg').height();
            }
			$('#svg_output').height( zoomed_height ); // slighly more for making sure we have no scroll bar	
		}
	}
    
    function highlight_id( id_string ) {
		$(id_string).css({
            "fill": "#ff0000",
            "stroke": "#ff0000",
            "fill-opacity": "1.0",
            "stroke-opacity": "1.0"
        });      
    	return;
    }

    function removeHighlight( id_string ) {
		$(id_string).css({
			"fill": "#000000",
            "stroke": "#000000",
            "fill-opacity": "1.0",
            "stroke-opacity": "1.0"
        });      
    	return;
    }

	function resizeAce() {
	 	$('#editor').height($(window).height() - $("#navbar").height() - 4);
	 	$('#editor').width($("#xml_panel").width());
	};
    
	function set_font( fontname ) {
		font = fontname
		apply_zoom();
	}
        
    function editSet( attr, value ) {
        if (drag_id.length == 0) {
            return;
        }
		editorAction = JSON.stringify({ action: 'set', param: { elementId: drag_id[0],
            attrType: attr, attrValue: value }   
	    });
        var res = vrvToolkit.edit( editorAction );
        reload_page( drag_id[0] );  
    };

    function editInsert( elementType ) {
        if ((drag_id.length < 2) || (drag_id[0] == drag_id[1]) ) {
            console.log("Select two (different) notes!")
            return;
        }
		editorAction = JSON.stringify({ action: 'insert', param: { elementType: elementType,
            startid: drag_id[1], endid: drag_id[0] }   
	    });
        var res = vrvToolkit.edit( editorAction );
        reload_page( drag_id[0] );  
    };
    
	function upload_file() {
		
		$('#submit-btn').popover('hide');
		var f = $("#mei_files").prop('files')[0];
		var reader = new FileReader();

		// Closure to capture the file information.
		reader.onload = (function(theFile) {
			return function(e) {
                $('.row-offcanvas').toggleClass('active');
				load_data(e.target.result);
			};
		})(f);

		// Read in the image file as a data URL.
		reader.readAsText(f);
	};

	function saveFile() {
		var fileName = prompt("Please enter the file name", "file.mei");

		if (fileName != null ) {
			var mei = editor.getValue();
			var meiBlob = new Blob([mei], {type: "text/plain;charset=utf-8"});
			saveAs(meiBlob, fileName);
		}
	}

	function openFile(evt) {
    	//Retrieve the first (and only!) File from the FileList object
    	var f = evt.target.files[0]; 

	    if (f) {
      		var r = new FileReader();
      		r.onload = function(e) { 
	      	var contents = e.target.result;
	      	load_data(contents);

      	}
      	r.readAsText(f);
	    } else { 
      	alert("Failed to load file");
	    }
	}

//]]>
</script>

    
<!-- top navbar -->
<div id="navbar" class="navbar navbar-default navbar-with-sidebar">
    <button type="button" class="navbar-toggle sidebar-toggle" data-toggle="offcanvas" data-target=".sidebar-nav">
         <span class="icon-bar"></span>
         <span class="icon-bar"></span>
         <span class="icon-bar"></span> 
    </button>
    <a class="navbar-brand logo-nav" href="{{ site.baseurl }}/index.xhtml">
        <img src="{{ site.baseurl }}/images/verovio-fadded-50.png" />
    </a>
    <div class="btn-group">
        <button type="button" class="btn btn-default btn-sm">Edit</button>
        <button type="button" class="btn btn-default btn-sm dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
            <span class="caret"></span>
            <span class="sr-only">Toggle Dropdown</span>
        </button>
        <ul class="dropdown-menu" role="menu">
            <li><a href="#" onclick="saveFile(); return false;">Save</a></li>
            <li><a href="#" onclick="undoAce(); return false;">Undo</a></li>
            <li><a href="#" onclick="redoAce(); return false;">Redo</a></li>
            <li role="separator" class="divider"></li>
            <li><a href="transposeOctave(); return false">Transpose octave</a></li>
            <li><a href="#" onclick="fetchAnnot('text/musicAnnot.xml', drag_id, 'music'); return false;">Add Critical Music Note</a></li>
            <li><a href="#" onclick="fetchAnnot('text/lyricAnnot.xml', drag_id, 'music'); return false;">Add Critical Lyric Note</a></li>
            <li><a href="#" onclick="updateAce(); return false;">Update Ace</a></li>
            <li><a href="#" onclick="updateVerovio(); return false;">Update Verovio</a></li> 
			<li><a href="#" onclick="$('#fileinput').trigger('click'); return false;">Open</a>
				<input id="fileinput" type="file" style="display: none;" /></li>		
        </ul>
    </div>
    <div class="btn-group" role="group">
			<button onclick="zoom_out()" class="btn btn-sm btn-default" type="button">
				<span class="glyphicon glyphicon-zoom-out"/>
			</button>
			<button onclick="zoom_in()" class="btn btn-sm  btn-default" type="button">
				<span class="glyphicon glyphicon-zoom-in"/>
			</button>
	</div>
    <div class="btn-group" role="group">
		<button onclick="first_page()" class="btn btn-sm btn-default" type="button">
			<span class="glyphicon glyphicon-fast-backward"/>
		</button>
		<button onclick="prev_page()" class="btn btn-sm btn-default" type="button">
			<span class="glyphicon glyphicon-backward"/>
		</button>
		<button onclick="next_page()" class="btn btn-sm btn-default" type="button">
			<span class="glyphicon glyphicon-forward"/>
		</button>
		<button onclick="last_page()" class="btn btn-sm btn-default" type="button">
			<span class="glyphicon glyphicon-fast-forward"/>
		</button>
	</div>
</div>
<div id="parent_panel">
	<div id="xml_panel" >
		<div id="editor"></div>
	</div>
	<div id="svg_panel" style="background-color: #fff;">
		<div id="svg_output" />
	</div>
</div>

<!-- sidebar -->
<div class="sidebar-offcanvas" id="sidebar" role="navigation">
	<div class="sidebar-panel">
		<div class="row">
			<div class="col-xs-12">
				<h4>Examples</h4>
			</div>
		</div>
		<div id="downloads_panel_body">
			<div class="row">
				<div class="col-md-12">
					{% for d in page.downloads %}
					<p><a href="{{ site.baseurl }}/{{ page.name }}?examples/downloads/{{ d.link }}">{{ d.name }}</a><br/>
						 {{ d.description }}
					 </p>
					{% endfor %}
				</div>
				<!-- /.col-md-6 -->
			</div>
			<!-- /.row -->
		</div>
        
		<div class="row">
			<div class="col-xs-12">
				<h4>Select MEI file</h4>
			</div>
		</div>
    
		<div id="options_panel_body">
			<form id="upload_form" onsubmit="upload_file( $('#upload_form') ); return false" class="form-inline" role="form">
				<div class="row">
					<div class="col-md-12">
						<input type="file" id="mei_files" onchange="$('#submit-btn').popover('show');" name="file" style="margin: 4px 0px 8px 0px;"/>
					</div>
					<div class="col-md-12">
						<button type="submit" id="submit-btn" class="btn btn-default btn-sm popover-btn" data-container="body" data-toggle="popover" data-placement="left" data-content="Click to display the MEI file!" data-trigger="manual">Render</button>
					</div>
				</div>

				<!--><div id="log_panel" style="display: none">
					<hr class="panel"/>
					<p id="log_p"></p>
				</div>
				-->
			</form>		
		</div>
	</div>
</div>

<div id="context-menu">
    <ul class="dropdown-menu" role="menu">
	    {% for d in page.context-menus %}
        {% if d.divider  %}<li class="divider"></li>
        {% else %}
	    <li><a class="ct-menu-{{ d.class }}" tabindex="-1" href="#" onclick="{{ d.action}}; return false;">{% if d.icon %}<span class="glyphicon {{ d.icon }}"/>  {% endif %}{{ d.name }}</a></li>
        {% endif %}
	    {% endfor %}
    </ul>
</div>




<script type="text/javascript">
//<![CDATA[
	$( document ).ready(function() {
		
		$(window).keyup(function(event){
			// We need to make sure not to capture event on text fields
			if ( $(event.target).hasClass('form-control') ) {
				return;
			}
			if ( event.ctrlKey && (event.keyCode == 37) ) {
				first_page();
			}
//			else if ( event.keyCode == 37 ) {
//				prev_page();
//			}
			else if ( event.ctrlKey && (event.keyCode == 39) ) {
				last_page();
			}
//			else if ( event.keyCode == 39 ) {
//				next_page();
//			}
			else if ( event.keyCode == 107 ) {
				zoom_in();
			}
			else if ( event.keyCode == 109 ) {
				zoom_out();
			}
		});
        
        $(window).resize(function(){
            apply_zoom();
        });
        
	    editor = ace.edit("editor");
   	    editor.getSession().setMode("ace/mode/xml");
   	    editor.$blockScrolling = Infinity;  // included to disable warning message
		resizeAce();

		document.getElementById('fileinput').addEventListener('change', openFile, false);

        $('#svg_output').on('click', ".note", function(e) {
            var t = e.target;

            // if we clicked a note:
            if (t.parentNode.getAttribute("class") == "note") {
		        var id = t.parentNode.attributes.id.value;

		        if (drag_id.indexOf(id) == -1) { // make sure we don't add it twice
		            drag_id.unshift(id);
					highlight_id("#" + id + " > rect, #" + id + " > use");
	    	    }
	        	else {
        	    	drag_id.splice( drag_id.indexOf(id), 1);
           			removeHighlight("#" + id + " > *");
		        }

		        editor.find('xml:id="' + id + '"');
    	    }
    	    // else if we clicked a lyric
            else if (t.parentNode.tagName == "text") {
            	var id = t.closest(".note").attributes.id.value;
                var verse_id = t.closest(".verse").attributes.id.value

                if (drag_id.indexOf(verse_id) == -1) {
                	drag_id.unshift(verse_id);
               	    highlight_id("#" + id + " > .verse");
                }
                else {
					drag_id.splice( drag_id.indexOf(verse_id), 1);
           			removeHighlight("#" + id + " > .verse");
                }
   		        editor.find('xml:id="' + verse_id + '"');
            }
        })

		$(window).resize(resizeAce);

        $('#svg_output').contextmenu( {
            before: function (e, element, target) {
                e.preventDefault();
                if (drag_id.length == 0) {
                    e.preventDefault();
                    this.closemenu();
                    return false;
                }
                return true;
            }
          });
        
       	// Adjust the size of the svg_output and the zoom according to the div (screen) siz
       	width = $('#svg_panel').width();
		zoom = Math.min( Math.floor( 100 * width / 2100 ), 40 );
	
		// Load the default file or the file passed in the URL
	 	var file = location.search.substring(1);
        console.log( file );
		if (file.length == 0) {
            file = "examples/downloads/M-04-6-02.mei";
        }
		$( "#toggle_options" ).click();
		$.get( file , function( data ) {
			load_data( data );
		}, 'text');
	});
//]]>
</script>
